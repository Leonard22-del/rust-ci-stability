name: Rust CI (stability)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # Recommended: keep it low first, then tune up if safe
      CARGO_BUILD_JOBS: "2"
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: System diagnostics (pre)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== SYSTEM INFO (PRE) ==="
          uname -a || true
          nproc || true
          free -h || true
          df -h || true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust diagnostics (pre)
        shell: bash
        run: |
          set -euo pipefail
          rustc -V
          cargo -V

      - name: Clean stale build artifacts
        shell: bash
        run: |
          set -euo pipefail
          echo "=== CLEANUP ==="
          rm -rf target || true
          cargo clean || true
          df -h || true

      # Swap is best-effort on GitHub-hosted runners. If it fails, the job continues.
      - name: Add swapfile (best effort)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== SWAP (BEST EFFORT) ==="
          if sudo fallocate -l 8G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=8192; then
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile || true
          fi
          swapon --show || true
          free -h || true

      - name: Build (limited parallelism)
        shell: bash
        run: |
          set -euo pipefail
          cargo build -j 2

      - name: Test (limited parallelism)
        shell: bash
        run: |
          set -euo pipefail
          cargo test -j 2 -- --test-threads=1

      - name: Repeat tests (stability check)
        shell: bash
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            echo "=== STABILITY RUN $i ==="
            rm -rf target
            cargo test -j 2 -- --test-threads=1
          done

      - name: Diagnostics (post)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "=== SYSTEM INFO (POST) ==="
          free -h || true
          df -h || true

          echo "=== OOM CHECK (POST) ==="
          dmesg -T | tail -n 250 | egrep -i "out of memory|oom|killed process" || true

          echo "=== DISK HOTSPOTS ==="
          du -sh target 2>/dev/null || true
          du -sh ~/.cargo/registry ~/.cargo/git 2>/dev/null || true
