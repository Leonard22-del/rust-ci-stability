name: Rust CI (stability)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      CARGO_BUILD_JOBS: "2"
      RUST_TEST_THREADS: "1"
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: System diagnostics (pre)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== SYSTEM INFO (PRE) ==="
          uname -a || true
          nproc || true
          free -h || true
          df -h || true
          swapon --show || true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust diagnostics (pre)
        shell: bash
        run: |
          set -euo pipefail
          rustc -V
          cargo -V

      # ✅ Make disk proof explicit: before + after
      - name: Free disk space (stale build artifacts + caches)
        shell: bash
        run: |
          set -euxo pipefail
          echo "=== DISK BEFORE CLEANUP ==="
          df -h

          # Repo artifacts
          rm -rf target || true
          cargo clean || true

          # Optional: cargo caches can be huge on runners
          rm -rf ~/.cargo/registry ~/.cargo/git || true

          echo "=== DISK AFTER CLEANUP ==="
          df -h

      # ✅ Make swap deterministic + prove it’s enabled
      - name: Add swapfile (required mitigation)
        shell: bash
        run: |
          set -euxo pipefail
          echo "=== SWAP SETUP ==="
          free -h || true
          swapon --show || true

          # Avoid conflicts
          sudo swapoff -a || true
          sudo rm -f /swapfile || true

          # 4G is usually enough; 8G can be too large if disk is tight
          SWAP_GB=4

          # Create swapfile
          sudo fallocate -l ${SWAP_GB}G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=$((SWAP_GB*1024))
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

          echo "=== SWAP ENABLED ==="
          swapon --show
          free -h

      - name: Build (limited parallelism)
        shell: bash
        run: |
          set -euxo pipefail
          echo "CARGO_BUILD_JOBS=$CARGO_BUILD_JOBS"
          cargo build -j 2 -v

      - name: Test (limited parallelism)
        shell: bash
        run: |
          set -euxo pipefail
          echo "RUST_TEST_THREADS=$RUST_TEST_THREADS"
          cargo test -j 2 -v -- --test-threads=1

      # ✅ Repeat without deleting target every time
      - name: Repeat tests (stability check)
        shell: bash
        run: |
          set -euxo pipefail
          for i in 1 2 3; do
            echo "=== STABILITY RUN $i ==="
            cargo test -j 2 -v -- --test-threads=1
          done

      - name: Diagnostics (post)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "=== SYSTEM INFO (POST) ==="
          free -h || true
          df -h || true
          swapon --show || true

          echo "=== OOM CHECK (POST) ==="
          dmesg -T | tail -n 250 | egrep -i "out of memory|oom|killed process" || true

          echo "=== DISK HOTSPOTS ==="
          du -sh target 2>/dev/null || true
          du -sh ~/.cargo/registry ~/.cargo/git 2>/dev/null || true
